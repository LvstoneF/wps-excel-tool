from constants import SEVERITY_MAP

class VulnerabilityExtractor:
    """漏洞提取器，负责从文件中提取漏洞信息"""
    
    @staticmethod
    def extract_vulnerabilities(rows):
        """从行数据中提取漏洞信息
        
        Args:
            rows (list): 行数据列表
        
        Returns:
            list: 漏洞字典列表
        """
        vulnerabilities = []
        current_vuln = {}
        
        for row in rows:
            # 跳过空行
            if not any(row):
                continue
            
            # 检查是否是新漏洞标题行（以【数字】开头）
            title_cell = row[1] if len(row) > 1 else row[0]
            if title_cell and isinstance(title_cell, str) and title_cell.startswith("【") and "】" in title_cell:
                # 如果有当前漏洞，先保存
                if current_vuln:
                    vulnerabilities.append(current_vuln)
                # 开始新漏洞
                current_vuln = {
                    "序号": title_cell.split("】")[0][1:],
                    "安全漏洞名称": title_cell.split("】")[1].strip()
                }
            # 处理属性行
            else:
                VulnerabilityExtractor._process_vulnerability_attribute(row, current_vuln)
        
        # 保存最后一个漏洞
        if current_vuln:
            vulnerabilities.append(current_vuln)
        
        return vulnerabilities
    
    @staticmethod
    def _process_vulnerability_attribute(row, current_vuln):
        """处理漏洞属性行，提取属性名称和值
        
        Args:
            row (tuple): 行数据
            current_vuln (dict): 当前漏洞字典
        """
        # 检查是否是标准格式（B列是属性名，C列是属性值）
        if len(row) >= 3 and row[1] and isinstance(row[1], str) and row[2]:
            VulnerabilityExtractor._extract_attribute_from_columns(row, current_vuln, 1, 2)
        # 兼容旧格式：A列是属性名，B列是属性值
        elif row[0] and isinstance(row[0], str) and len(row) > 1 and row[1]:
            VulnerabilityExtractor._extract_attribute_from_columns(row, current_vuln, 0, 1)
        # 兼容DOCX格式：单行属性（如"危险级别：高"）
        elif len(row) >= 1 and row[0] and isinstance(row[0], str):
            VulnerabilityExtractor._extract_attribute_from_single_line(row[0], current_vuln)
    
    @staticmethod
    def _extract_attribute_from_columns(row, current_vuln, name_col, value_col):
        """从指定列提取属性名称和值
        
        Args:
            row (tuple): 行数据
            current_vuln (dict): 当前漏洞字典
            name_col (int): 属性名称所在列索引
            value_col (int): 属性值所在列索引
        """
        attr_name = row[name_col].strip()
        attr_value = row[value_col].strip()
        VulnerabilityExtractor._update_vulnerability_attribute(current_vuln, attr_name, attr_value)
    
    @staticmethod
    def _extract_attribute_from_single_line(text, current_vuln):
        """从单行文本中提取属性名称和值
        
        Args:
            text (str): 单行文本
            current_vuln (dict): 当前漏洞字典
        """
        text = text.strip()
        if ":" in text:
            attr_name, attr_value = text.split(":", 1)
            attr_name = attr_name.strip()
            attr_value = attr_value.strip()
            VulnerabilityExtractor._update_vulnerability_attribute(current_vuln, attr_name, attr_value)
    
    @staticmethod
    def _update_vulnerability_attribute(current_vuln, attr_name, attr_value):
        """更新漏洞属性，使用类常量作为危险级别映射
        
        Args:
            current_vuln (dict): 当前漏洞字典
            attr_name (str): 属性名称
            attr_value (str): 属性值
        """
        if attr_name == "危险级别":
            # 映射危险级别到严重程度
            current_vuln["严重程度"] = SEVERITY_MAP.get(attr_value, attr_value)
        elif attr_name == "存在主机":
            current_vuln["关联资产/域名"] = attr_value
    
    @staticmethod
    def convert_vulnerabilities_to_list(vulnerabilities):
        """将漏洞字典列表转换为列表格式，过滤掉严重程度为"信息"的条目
        
        Args:
            vulnerabilities (list): 漏洞字典列表
        
        Returns:
            list: 列表格式的漏洞数据
        """
        result_data = []
        for vuln in vulnerabilities:
            severity = vuln.get("严重程度", "")
            # 只保留严重程度不是"信息"的条目
            if severity != "信息":
                row_data = [
                    vuln.get("序号", ""),
                    vuln.get("安全漏洞名称", ""),
                    vuln.get("关联资产/域名", ""),
                    severity
                ]
                result_data.append(row_data)
        return result_data
